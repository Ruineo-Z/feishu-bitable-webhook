# 框架重构任务分解

## 阶段一：数据解析层

### 1.1 创建解析器目录结构

**文件**：`src/parser/index.ts`

**任务**：
- 定义 `EventParser` 接口
- 定义 `ParsedEvent` 类型
- 定义 `EventType` 类型

**验收标准**：
- [ ] 接口定义清晰
- [ ] 类型定义完整
- [ ] 有详细的 JSDoc 注释

### 1.2 实现飞书事件解析器

**文件**：`src/parser/feishu-parser.ts`

**任务**：
- 实现 `FeishuEventParser` 类
- 支持 `v1` 和 `v2` 事件格式
- 实现事件去重逻辑

**验收标准**：
- [ ] 能正确解析飞书 v1 和 v2 事件
- [ ] 事件去重正常工作
- [ ] 有单元测试覆盖

### 1.3 实现字段类型转换器

**文件**：`src/parser/field-converter.ts`

**任务**：
- 实现 `FieldTypeConverter` 类
- 支持所有飞书字段类型
- 处理边界情况（null, undefined）

**验收标准**：
- [ ] 支持所有飞书字段类型
- [ ] 边界情况处理正确
- [ ] 有单元测试覆盖

### 1.4 集成解析器到主流程

**文件**：`src/lark.ts`

**任务**：
- 简化 `processEvent` 函数
- 调用解析器获取 `ParsedEvent`
- 保持现有功能兼容

**验收标准**：
- [ ] 代码更清晰
- [ ] 现有功能不受影响
- [ ] 集成测试通过

---

## 阶段二：条件评估器增强

### 2.1 新增字段类型处理器

**文件**：`src/engine/condition-evaluator.ts`

**任务**：
- 新增 `FieldTypeHandler` 接口
- 实现单选、多选、人员、日期、复选框、关联表处理器

**验收标准**：
- [ ] 支持所有飞书字段类型
- [ ] 条件评估结果正确
- [ ] 有单元测试覆盖

### 2.2 更新条件评估逻辑

**文件**：`src/engine/condition-evaluator.ts`

**任务**：
- 根据字段类型选择对应的处理器
- 支持嵌套类型（数组、对象）
- 优化错误处理

**验收标准**：
- [ ] 类型判断准确
- [ ] 错误信息清晰
- [ ] 性能无明显下降

---

## 阶段三：日志记录完善

### 3.1 扩展日志接口

**文件**：`src/db/execution-logs.ts`

**任务**：
- 新增 `ActionExecution` 类型
- 扩展 `ExecutionLog` 接口
- 保持向后兼容

**验收标准**：
- [ ] 接口定义清晰
- [ ] 向后兼容（已有日志可正常读取）
- [ ] 数据库迁移脚本可用

### 3.2 修改日志记录逻辑

**文件**：`src/lark.ts`

**任务**：
- 记录每个动作的独立结果
- 记录规则版本号
- 记录完整的字段快照

**验收标准**：
- [ ] 每个动作都有独立记录
- [ ] 快照信息完整
- [ ] 日志可查询、可追溯

### 3.3 添加日志查询增强

**文件**：`src/db/execution-logs.ts`

**任务**：
- 支持按动作类型查询
- 支持按状态查询
- 支持分页和排序

**验收标准**：
- [ ] 查询功能正常
- [ ] 性能可接受
- [ ] 文档齐全

---

## 阶段四：跨表格操作

### 4.1 创建跨表格动作组件

**文件**：`src/actions/cross-table.ts`

**任务**：
- 定义 `CrossTableParams` 接口
- 实现 `crossTableAction` 处理器

**验收标准**：
- [ ] 接口定义清晰
- [ ] 基本功能正常
- [ ] 有详细的 JSDoc 注释

### 4.2 实现字段映射和转换

**文件**：`src/actions/cross-table.ts`

**任务**：
- 支持字段直接映射
- 支持简单转换函数
- 支持条件过滤

**验收标准**：
- [ ] 字段映射正确
- [ ] 转换函数正常工作
- [ ] 边界情况处理正确

### 4.3 添加跨表格动作到注册表

**文件**：`src/actions/registry.ts`

**任务**：
- 注册 `cross-table` 动作
- 更新动作列表

**验收标准**：
- [ ] 动作可正常注册
- [ ] 动作可正常执行
- [ ] 文档齐全

### 4.4 编写跨表格操作测试

**任务**：
- 单元测试
- 集成测试

**验收标准**：
- [ ] 测试覆盖率不低于 80%
- [ ] 主要场景覆盖

---

## 任务总览

| 阶段 | 任务 | 预估工时 | 优先级 |
|------|------|----------|--------|
| 1.1 | 创建解析器目录结构 | 1h | P0 |
| 1.2 | 实现飞书事件解析器 | 4h | P0 |
| 1.3 | 实现字段类型转换器 | 3h | P0 |
| 1.4 | 集成解析器到主流程 | 2h | P0 |
| 2.1 | 新增字段类型处理器 | 4h | P1 |
| 2.2 | 更新条件评估逻辑 | 2h | P1 |
| 3.1 | 扩展日志接口 | 2h | P1 |
| 3.2 | 修改日志记录逻辑 | 3h | P1 |
| 3.3 | 添加日志查询增强 | 2h | P2 |
| 4.1 | 创建跨表格动作组件 | 4h | P1 |
| 4.2 | 实现字段映射和转换 | 4h | P1 |
| 4.3 | 添加到注册表 | 1h | P1 |
| 4.4 | 编写测试 | 4h | P2 |

**总计预估工时**：36 小时

---

## 里程碑

| 里程碑 | 包含任务 | 目标日期 |
|--------|----------|----------|
| M1：数据解析层完成 | 1.1 - 1.4 | 第 1 周 |
| M2：条件评估器增强 | 2.1 - 2.2 | 第 2 周 |
| M3：日志记录完善 | 3.1 - 3.3 | 第 2 周 |
| M4：跨表格操作 | 4.1 - 4.4 | 第 3-4 周 |
